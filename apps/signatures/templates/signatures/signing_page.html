<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semnare Mandat - {{ case.client.full_name }}</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; padding: 20px; text-align: center; background: #f4f4f9; color: #333; }
        h3 { margin-bottom: 10px; }
        
        /* Stil pentru Contractul Vizibil */
        .contract-container {
            background: #fff;
            border: 1px solid #ccc;
            padding: 25px;
            margin: 0 auto 20px auto;
            text-align: justify;
            height: 450px;       /* ÃŽnÄƒlÈ›ime fixÄƒ */
            overflow-y: scroll;  /* Scroll dacÄƒ e text mult */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 600px;
            border-radius: 4px;
            line-height: 1.6;
            font-size: 14px;
        }

        .contract-container p { margin-bottom: 15px; }
        .contract-container ul { margin-bottom: 10px; padding-left: 20px; }
        .highlight { background-color: #fffde7; padding: 2px 5px; font-weight: bold; border-radius: 3px; }
        .bold { font-weight: bold; }
        .underline { text-decoration: underline; }

        h4 { text-align: center; margin-top: 0; margin-bottom: 5px; text-transform: uppercase; }
        h5 { text-align: center; margin-top: 0; margin-bottom: 20px; text-transform: uppercase; font-size: 1em; }

        canvas { 
            border: 2px dashed #4CAF50; 
            background: #fff; 
            cursor: crosshair; 
            touch-action: none; 
            border-radius: 8px;
            margin-top: 10px;
        }

        .btn { 
            background: #25D366; color: white; padding: 15px 30px; margin-top: 15px;
            border: none; font-size: 16px; border-radius: 30px; cursor: pointer; width: 100%; max-width: 300px;
            font-weight: bold;
        }
        .btn:disabled { background: #ccc; }
        .btn-clear { background: #ff4444; margin-bottom: 10px; font-size: 14px; padding: 10px 20px; }
    </style>
</head>
<body>

    <h3>Mandat de Reprezentare</h3>
    <p style="font-size: 12px; color: #666;">Te rog citeÈ™te documentul de mai jos È™i semneazÄƒ Ã®n chenar.</p>
    
    <div class="contract-container">
        <h4>- IMPUTERNICIRE -</h4>
        <h5>- MANDAT DE REPREZENTARE -</h5>
        
        <p>
            Subsemnatul/Subscrisa <span class="highlight">{{ client.full_name|default:"_______________________________________" }}</span>
            cu domiciliul / sediul Ã®n <span class="highlight">{{ client.address|default:"Loc. ________________ str. ____________________________ nr. ____, bl. ____, sc. ____, et. ____, ap. ____, jud. ________________________" }}</span>,
            identificat/Äƒ cu C.I. seria <span class="highlight">{{ client.id_series|default:"____" }}</span>
            nr. <span class="highlight">{{ client.id_number|default:"_____________" }}</span>,
            avand CNP/CUI <span class="highlight">{{ client.cnp|default:"_________________________________________" }}</span>,
            Tel: <span class="highlight">{{ client.phone_number|default:"________________________________" }}</span>
            e-mail <span class="highlight">{{ client.email|default:"___________________________________________________________" }}</span>
            Ã®n calitate de membru al AsociaÈ›iei PÄƒgubiÈ›ilor RCA, imputernicesc cu puteri depline pe:
        </p>

        <p>
            <strong>AsociaÈ›ia PÄƒgubiÈ›ilor RCA</strong>, avand sediul procesual ales pentru corespondenta in str. Poet Grigore Alexandrescu Bl. E3 Parter, Loc. Targoviste , Jud. Dambovita, CIF: 41401972 , Nr. Reg. Asociatii si Fundatii la poziÈ›ia 13/I/A/10.06.2019, Call center 021.9906 , Direct Line 0731.007.658 , Tel Fix: 0245.651.000 , E-mail: office@aprca.ro sa imi reprezinte interesele in fata tuturor institutiilor publice competente, persoane fizice si juridice, I.P.J, IGPR, R.A.R, I.S.U, UPU, Unitati spitalicesti, ASF, SAL-Fin, FGA, ANSPDCP, EIOPA, CoB, Institutul Avocatului Poporului, Parlamentul Romaniei, Senatul Romaniei, Administratia Prezidentiale precum si in fata oricarui asigurator din Romania sau reprezentanti si/sau corespondenti ai asiguratorilor externi, in fata BAAR, precum si la sediul oricarui service auto, societate de rent a car, societate de transport-tractari, in vederea sustinerii intereselor mele privind incasarea despagubirilor , a penalitatilor de intarziere si a oricaror alte sume de bani cuvenite legal in urma evenimentului rutier in care am fost implicat cu autovehiculul/motociclul/remorca:
        </p>

        <p>
            Marca: <span class="highlight">{{ vehicle.make|default:"_______________________" }}</span>
            Tipul: <span class="highlight">{{ vehicle.model|default:"_______________________" }}</span>
            avand nr. inmatriculare: <span class="highlight">{{ vehicle.license_plate|default:"_______________________" }}</span>
            cu seria de sasiu <span class="highlight">{{ vehicle.vin_number|default:"_________________________________________" }}</span>
            pt constatarea, instrumentarea si lichidarea prin plata integrala a daunelor de catre asiguratori, BAAR sau FGA in urma evenimentului rutier din data de <span class="highlight">{{ case.accident_date|date:"d.m.Y"|default:"______________________" }}</span>
        </p>

        <p>
            Pentru indeplinirea acestui mandat, MANDATARUL se va prezenta la asiguratori, la service-uri, va depune si va ridica toate actele/documentele sau certificatele solicitate, va putea verifica si semna devizele de reparatie, notele de constatare, facturile emise de: unitatile reparatoare, societati specializate in tractari auto precum si societati de inchiriere auto
        </p>

        <p>
            Asociatia Pagubitilor RCA va putea face orice fel de declaratii-petitii-reclamatii necesare in fata oricaror institutii publice sau private sus-mentionate, in vederea apararii drepturilor si intereselor mele legale semnatura lui fiindu-mi opozabila.
        </p>

        <p>
            In sustinerea intereselor mele legale, mandatarul va putea depune plangere/actiune catre parchetele de pe langa judecatoriile din aria de jurisdictie, catre orice instanta de orice grad, va putea angaja si un avocat prin semnarea contractului de asistenta juridica cu toate drepturile si obligatiile ce decurg din acesta.
        </p>

        <p>
            Mandatul este acceptat de catre mandatar fiind valabil pana la indeplinirea scopului pentru care a fost eliberat, dar nu mai mult de 3(trei) ani conform prevederilor Art.2015 N.C.Civ.
        </p>

        <br>
        <p>Data semnÄƒrii: <strong>{{ date }}</strong></p>
    </div>

    <p><strong>SemneazÄƒ aici cu degetul:</strong></p>
    <canvas id="signature-pad" width="320" height="200"></canvas>
    
    <br>
    <button class="btn btn-clear" onclick="signaturePad.clear()">È˜terge / ÃŽncearcÄƒ din nou</button>
    <br>
    <button class="btn" id="saveBtn" onclick="submitSignature()">âœ… Confirm È™i Semnez</button>

    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        var canvas = document.getElementById('signature-pad');
        
        // Ajustare Canvas pentru Mobile (Retina display fix)
        function resizeCanvas() {
            var ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        window.onresize = resizeCanvas;
        resizeCanvas();

        var signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

        function submitSignature() {
            if (signaturePad.isEmpty()) {
                alert("Te rog sÄƒ semnezi Ã®n chenar Ã®nainte de a trimite.");
                return;
            }

            var btn = document.getElementById('saveBtn');
            btn.innerText = "Se genereazÄƒ documentul...";
            btn.disabled = true;

            var data = signaturePad.toDataURL("image/png");
            var csrfToken = document.getElementById('csrf_token').value; // LuÄƒm tokenul

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken  // <--- REZOLVAREA PENTRU EROAREA 403
                },
                body: 'signature=' + encodeURIComponent(data)
            })
            .then(response => {
                if (!response.ok) { throw new Error("HTTP " + response.status); }
                return response.json();
            })
            .then(data => {
                if(data.status === 'success') {
                    document.body.innerHTML = `
                        <div style='margin-top:50px; color:green;'>
                            <h1>ðŸŽ‰ Document Semnat!</h1>
                            <p>Mandatul a fost generat È™i salvat la dosar.</p>
                            <p>PoÈ›i Ã®nchide aceastÄƒ paginÄƒ È™i reveni pe WhatsApp.</p>
                        </div>`;
                } else {
                    alert("Eroare server: " + data.message);
                    btn.disabled = false;
                    btn.innerText = "âœ… Confirm È™i Semnez";
                }
            })
            .catch(error => {
                alert("Eroare de conexiune: " + error);
                btn.disabled = false;
                btn.innerText = "âœ… Confirm È™i Semnez";
            });
        }
    </script>
</body>
</html>