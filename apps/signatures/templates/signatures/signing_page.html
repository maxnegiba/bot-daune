<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semnare Mandat - {{ case.client.full_name }}</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; padding: 20px; text-align: center; background: #f4f4f9; color: #333; }
        h3 { margin-bottom: 10px; }
        
        /* Stil pentru Contractul Vizibil */
        .contract-container {
            background: #fff;
            border: 1px solid #ccc;
            padding: 25px;
            margin: 0 auto 20px auto;
            text-align: justify;
            height: 350px;       /* ÃŽnÄƒlÈ›ime fixÄƒ */
            overflow-y: scroll;  /* Scroll dacÄƒ e text mult */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 600px;
            border-radius: 4px;
            line-height: 1.6;
            font-size: 14px;
        }

        .contract-container p { margin-bottom: 10px; }
        .contract-container ul { margin-bottom: 10px; padding-left: 20px; }
        .highlight { background-color: #fffde7; padding: 2px 5px; font-weight: bold; border-radius: 3px; }

        canvas { 
            border: 2px dashed #4CAF50; 
            background: #fff; 
            cursor: crosshair; 
            touch-action: none; 
            border-radius: 8px;
            margin-top: 10px;
        }

        .btn { 
            background: #25D366; color: white; padding: 15px 30px; margin-top: 15px;
            border: none; font-size: 16px; border-radius: 30px; cursor: pointer; width: 100%; max-width: 300px;
            font-weight: bold;
        }
        .btn:disabled { background: #ccc; }
        .btn-clear { background: #ff4444; margin-bottom: 10px; font-size: 14px; padding: 10px 20px; }
    </style>
</head>
<body>

    <h3>Mandat de Reprezentare</h3>
    <p style="font-size: 12px; color: #666;">Te rog citeÈ™te documentul de mai jos È™i semneazÄƒ Ã®n chenar.</p>
    
    <div class="contract-container">
        <h4 style="text-align: center;">MANDAT DE REPREZENTARE</h4>
        
        <p>Subsemnatul(a), <span class="highlight">{{ client.full_name|default:"........................" }}</span>, identificat(Äƒ) cu CNP <span class="highlight">{{ client.cnp|default:"........................" }}</span>,</p>

        <p>Prin prezenta Ã®mputernicesc societatea <strong>AUTO DAUNE SRL</strong> sÄƒ mÄƒ reprezinte cu puteri depline Ã®n faÈ›a asiguratorului Ã®n vederea instrumentÄƒrii, soluÈ›ionÄƒrii È™i Ã®ncasÄƒrii despÄƒgubirii aferente dosarului de daunÄƒ deschis pentru evenimentul rutier.</p>

        <p>Mandatarul are dreptul sÄƒ:</p>
        <ul>
            <li>DepunÄƒ È™i sÄƒ ridice documente Ã®n numele meu;</li>
            <li>SÄƒ solicite reconstatarea avariilor;</li>
            <li>SÄƒ negocieze cuantumul despÄƒgubirii;</li>
            <li>SÄƒ Ã®ncaseze despÄƒgubirea Ã®n contul bancar al unitÄƒÈ›ii reparatoare (Ã®n cazul plÄƒÈ›ii directe).</li>
        </ul>

        <p>Declar pe proprie rÄƒspundere cÄƒ accept oferta de despÄƒgubire sau reparaÈ›ia conform condiÈ›iilor agreate È™i cÄƒ datele furnizate sunt reale.</p>

        <br>
        <p>Data semnÄƒrii: <strong>{{ date }}</strong></p>
    </div>

    <p><strong>SemneazÄƒ aici cu degetul:</strong></p>
    <canvas id="signature-pad" width="320" height="200"></canvas>
    
    <br>
    <button class="btn btn-clear" onclick="signaturePad.clear()">È˜terge / ÃŽncearcÄƒ din nou</button>
    <br>
    <button class="btn" id="saveBtn" onclick="submitSignature()">âœ… Confirm È™i Semnez</button>

    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        var canvas = document.getElementById('signature-pad');
        
        // Ajustare Canvas pentru Mobile (Retina display fix)
        function resizeCanvas() {
            var ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        window.onresize = resizeCanvas;
        resizeCanvas();

        var signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

        function submitSignature() {
            if (signaturePad.isEmpty()) {
                alert("Te rog sÄƒ semnezi Ã®n chenar Ã®nainte de a trimite.");
                return;
            }

            var btn = document.getElementById('saveBtn');
            btn.innerText = "Se genereazÄƒ documentul...";
            btn.disabled = true;

            var data = signaturePad.toDataURL("image/png");
            var csrfToken = document.getElementById('csrf_token').value; // LuÄƒm tokenul

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken  // <--- REZOLVAREA PENTRU EROAREA 403
                },
                body: 'signature=' + encodeURIComponent(data)
            })
            .then(response => {
                if (!response.ok) { throw new Error("HTTP " + response.status); }
                return response.json();
            })
            .then(data => {
                if(data.status === 'success') {
                    document.body.innerHTML = `
                        <div style='margin-top:50px; color:green;'>
                            <h1>ðŸŽ‰ Document Semnat!</h1>
                            <p>Mandatul a fost generat È™i salvat la dosar.</p>
                            <p>PoÈ›i Ã®nchide aceastÄƒ paginÄƒ È™i reveni pe WhatsApp.</p>
                        </div>`;
                } else {
                    alert("Eroare server: " + data.message);
                    btn.disabled = false;
                    btn.innerText = "âœ… Confirm È™i Semnez";
                }
            })
            .catch(error => {
                alert("Eroare de conexiune: " + error);
                btn.disabled = false;
                btn.innerText = "âœ… Confirm È™i Semnez";
            });
        }
    </script>
</body>
</html>