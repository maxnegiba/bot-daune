<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistent Daune Auto</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { width: 100%; max-width: 480px; background: white; height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; }

        /* LOGIN SCREEN */
        #login-screen { display: flex; flex-direction: column; justify-content: center; padding: 40px; height: 100%; background: white; z-index: 10; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        h2 { color: #333; margin-bottom: 10px; text-align: center; }
        p { color: #666; margin-bottom: 30px; text-align: center; font-size: 14px; }
        input { padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; transition: border 0.3s; }
        input:focus { border-color: #007bff; }
        button.primary-btn { padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: background 0.3s; }
        button.primary-btn:hover { background: #0056b3; }

        /* CHAT SCREEN */
        #chat-screen { display: none; flex-direction: column; height: 100%; }
        header { background: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header button { background: transparent; border: none; color: white; cursor: pointer; font-size: 12px; }

        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background: #f9f9fc; scroll-behavior: smooth; }

        .message-row { display: flex; flex-direction: column; max-width: 85%; }
        .message-row.in { align-self: flex-end; align-items: flex-end; } /* User */
        .message-row.out { align-self: flex-start; align-items: flex-start; } /* Bot */

        .message-bubble { padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; word-wrap: break-word; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .message-row.in .message-bubble { background: #007bff; color: white; border-bottom-right-radius: 4px; }
        .message-row.out .message-bubble { background: white; color: #333; border-bottom-left-radius: 4px; border: 1px solid #eee; }

        .timestamp { font-size: 10px; opacity: 0.6; margin-top: 4px; margin-right: 5px; }

        /* Buttons */
        .buttons-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .chat-option-btn { background: white; border: 1px solid #007bff; color: #007bff; padding: 8px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .chat-option-btn:hover { background: #eef6ff; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,123,255,0.1); }

        /* Footer */
        footer { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        #msg-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 14px; background: #f8f9fa; }
        #msg-input:focus { background: white; border-color: #007bff; }

        #file-btn { background: #f0f2f5; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; transition: background 0.2s; }
        #file-btn:hover { background: #e4e6eb; }

        #send-btn { background: #007bff; color: white; width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; font-size: 18px; cursor: pointer; transition: background 0.2s; }
        #send-btn:hover { background: #0056b3; }

        .loading-indicator { text-align: center; color: #999; font-size: 12px; padding: 5px; font-style: italic; }

        /* Scrollbar */
        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        #messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <h2>ðŸ‘‹ Bun venit!</h2>
        <p>Asistentul tÄƒu digital pentru daune auto.<br>IntroduceÈ›i datele pentru a Ã®ncepe.</p>

        <label for="phone" style="font-size: 12px; color: #555; margin-left: 5px;">NumÄƒr Telefon</label>
        <input type="tel" id="phone" placeholder="Ex: 0722123456" />

        <label for="name" style="font-size: 12px; color: #555; margin-left: 5px; margin-top: 10px;">Numele TÄƒu (OpÈ›ional)</label>
        <input type="text" id="name" placeholder="Ex: Ion Popescu" />

        <button class="primary-btn" onclick="login()">ÃŽncepe ConversaÈ›ia</button>
        <p id="login-error" style="color: #dc3545; margin-top: 15px; font-size: 13px;"></p>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen">
        <header>
            <div>Asistent Daune</div>
            <button onclick="logout()">IeÈ™ire</button>
        </header>

        <div id="messages">
            <!-- Messages go here -->
        </div>

        <footer>
            <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileSelect()" />
            <button id="file-btn" onclick="document.getElementById('file-input').click()" title="AtaÈ™eazÄƒ fiÈ™iere">ðŸ“Ž</button>

            <input type="text" id="msg-input" placeholder="Scrie un mesaj..." onkeypress="handleEnter(event)" autocomplete="off" />

            <button id="send-btn" onclick="sendMessage()">âž¤</button>
        </footer>
    </div>
</div>

<script>
    let caseId = null;
    let clientId = null;
    let lastMsgId = 0;
    let pollingInterval = null;

    // --- INITIALIZATION ---
    window.onload = function() {
        const storedCase = localStorage.getItem('case_id');
        const storedPhone = localStorage.getItem('phone');

        if (storedCase && storedPhone) {
             document.getElementById('phone').value = storedPhone;
             // Auto-login attempt
             login(true);
        }
    }

    // --- AUTH ---
    async function login(isAuto = false) {
        const phone = document.getElementById('phone').value.trim();
        const name = document.getElementById('name').value.trim();
        const errElem = document.getElementById('login-error');

        if (!phone) {
            if(!isAuto) errElem.innerText = "Te rugÄƒm sÄƒ introduci numÄƒrul de telefon.";
            return;
        }

        const btn = document.querySelector('#login-screen button');
        btn.disabled = true;
        btn.innerText = "Se conecteazÄƒ...";

        try {
            const res = await fetch('/bot/chat/login/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone, name})
            });
            const data = await res.json();

            if (data.success) {
                caseId = data.case_id;
                clientId = data.client_id;

                localStorage.setItem('case_id', caseId);
                localStorage.setItem('phone', phone);

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';

                loadHistory();
                startPolling();
            } else {
                errElem.innerText = data.error || "Eroare la autentificare";
            }
        } catch (e) {
            errElem.innerText = "Eroare de conexiune. VerificÄƒ internetul.";
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "ÃŽncepe ConversaÈ›ia";
        }
    }

    function logout() {
        localStorage.removeItem('case_id');
        localStorage.removeItem('phone');
        location.reload();
    }

    // --- MESSAGING ---
    async function loadHistory() {
        try {
            const res = await fetch(`/bot/chat/history/?case_id=${caseId}`);
            const data = await res.json();
            const msgs = document.getElementById('messages');
            msgs.innerHTML = '';
            lastMsgId = 0;

            if (data.messages) {
                data.messages.forEach(msg => {
                    appendMessage(msg);
                    if (msg.id > lastMsgId) lastMsgId = msg.id;
                });
                setTimeout(scrollToBottom, 100);
            }
        } catch (e) {
            console.error("History error:", e);
        }
    }

    function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
            if (!caseId) return;
            try {
                const res = await fetch(`/bot/chat/poll/?case_id=${caseId}&last_id=${lastMsgId}`);
                const data = await res.json();
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        // Prevent duplicates strictly
                        if (msg.id > lastMsgId) {
                            appendMessage(msg);
                            lastMsgId = msg.id;
                        }
                    });
                    scrollToBottom();
                }
            } catch (e) {
                console.error("Polling error:", e);
            }
        }, 3000); // Poll every 3 seconds
    }

    function appendMessage(msg) {
        const msgs = document.getElementById('messages');
        const row = document.createElement('div');

        // Determine direction
        // msg.direction: 'IN' (User) or 'OUT' (Bot)
        const isUser = msg.direction === 'IN';
        row.className = `message-row ${isUser ? 'in' : 'out'}`;

        // Bubble
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        // Format content (basic link detection and newlines)
        let content = msg.content || "";
        content = content.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // XSS protect
        content = content.replace(/\n/g, '<br>');
        // Linkify
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        content = content.replace(urlRegex, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>');

        bubble.innerHTML = content;
        row.appendChild(bubble);

        // Timestamp
        const ts = document.createElement('div');
        ts.className = 'timestamp';
        try {
            const date = new Date(msg.timestamp);
            ts.innerText = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch(e) { ts.innerText = ""; }
        row.appendChild(ts);

        // Buttons (Interactive) - Only for Bot messages
        if (!isUser && msg.metadata && msg.metadata.buttons) {
             const btnContainer = document.createElement('div');
             btnContainer.className = 'buttons-container';
             msg.metadata.buttons.forEach(btnText => {
                 const btn = document.createElement('button');
                 btn.className = 'chat-option-btn';
                 btn.innerText = btnText;
                 btn.onclick = () => sendMessage(btnText);
                 btnContainer.appendChild(btn);
             });
             // Append buttons to the ROW, inside or outside bubble?
             // Outside looks better usually.
             row.appendChild(btnContainer);
        }

        msgs.appendChild(row);
    }

    function scrollToBottom() {
        const msgs = document.getElementById('messages');
        msgs.scrollTop = msgs.scrollHeight;
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage(text = null) {
        const input = document.getElementById('msg-input');
        const val = text || input.value.trim();

        if (!val) return;

        input.value = ''; // Clear input immediately
        input.focus();

        // Optimistic append?
        // No, let polling handle it to ensure order and confirmation.
        // But we might want to show a "sending..." state?
        // For simplicity, just wait for poll.

        // Construct FormData
        const formData = new FormData();
        formData.append('case_id', caseId);
        formData.append('message', val);

        try {
            await fetch('/bot/chat/send/', {
                method: 'POST',
                body: formData
            });
            // Don't manually append. Poll will catch it.
        } catch (e) {
            alert("Eroare trimitere: " + e.message);
        }
    }

    async function handleFileSelect() {
        const input = document.getElementById('file-input');
        if (input.files.length > 0) {
            const formData = new FormData();
            formData.append('case_id', caseId);

            // Append files
            for (let i = 0; i < input.files.length; i++) {
                // Name 'file_0', 'file_1' etc doesn't matter much as backend iterates all FILES
                formData.append('file_' + i, input.files[i]);
            }

            // UI Feedback
            const msgs = document.getElementById('messages');
            const loading = document.createElement('div');
            loading.className = 'loading-indicator';
            loading.innerText = 'Se Ã®ncarcÄƒ fiÈ™ierele...';
            msgs.appendChild(loading);
            scrollToBottom();

            try {
                await fetch('/bot/chat/send/', {
                    method: 'POST',
                    body: formData
                });
                loading.remove();
                // Reset input
                input.value = '';
            } catch (e) {
                loading.innerText = 'Eroare upload.';
                console.error(e);
            }
        }
    }
</script>

</body>
</html>
