<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistent Daune Auto</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { width: 100%; max-width: 480px; background: white; height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; }

        /* LOGIN SCREEN */
        #login-screen { display: flex; flex-direction: column; justify-content: center; padding: 40px; height: 100%; background: white; z-index: 10; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        h2 { color: #333; margin-bottom: 10px; text-align: center; }
        p { color: #666; margin-bottom: 30px; text-align: center; font-size: 14px; }
        input { padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; transition: border 0.3s; }
        input:focus { border-color: #007bff; }
        button.primary-btn { padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: background 0.3s; }
        button.primary-btn:hover { background: #0056b3; }

        /* CHAT SCREEN */
        #chat-screen { display: none; flex-direction: column; height: 100%; }
        header { background: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header button { background: transparent; border: none; color: white; cursor: pointer; font-size: 12px; }

        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background: #f9f9fc; scroll-behavior: smooth; }

        .message-row { display: flex; flex-direction: column; max-width: 85%; }
        .message-row.in { align-self: flex-end; align-items: flex-end; } /* User */
        .message-row.out { align-self: flex-start; align-items: flex-start; } /* Bot */

        .message-bubble { padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; word-wrap: break-word; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .message-row.in .message-bubble { background: #007bff; color: white; border-bottom-right-radius: 4px; }
        .message-row.out .message-bubble { background: white; color: #333; border-bottom-left-radius: 4px; border: 1px solid #eee; }

        .timestamp { font-size: 10px; opacity: 0.6; margin-top: 4px; margin-right: 5px; }

        /* Buttons */
        .buttons-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .chat-option-btn { background: white; border: 1px solid #007bff; color: #007bff; padding: 8px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .chat-option-btn:hover { background: #eef6ff; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,123,255,0.1); }

        /* Footer */
        footer { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        #msg-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 14px; background: #f8f9fa; }
        #msg-input:focus { background: white; border-color: #007bff; }

        #file-btn { background: #f0f2f5; color: #555; width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; transition: background 0.2s; }
        #file-btn:hover { background: #e4e6eb; }

        #send-btn { background: #007bff; color: white; width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; font-size: 18px; cursor: pointer; transition: background 0.2s; }
        #send-btn:hover { background: #0056b3; }

        .loading-indicator { text-align: center; color: #999; font-size: 12px; padding: 5px; font-style: italic; }

        /* Scrollbar */
        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        #messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <h2>ðŸ‘‹ Bun venit!</h2>
        <p>Asistentul tÄƒu digital pentru daune auto.<br>IntroduceÈ›i datele pentru a Ã®ncepe.</p>

        <label for="phone" style="font-size: 12px; color: #555; margin-left: 5px;">NumÄƒr Telefon</label>
        <input type="tel" id="phone" placeholder="Ex: 0722123456" />

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label for="last_name" style="font-size: 12px; color: #555; margin-left: 5px; margin-top: 10px;">Nume</label>
                <input type="text" id="last_name" placeholder="Ex: Popescu" style="width: 100%; box-sizing: border-box;" />
            </div>
            <div style="flex: 1;">
                <label for="first_name" style="font-size: 12px; color: #555; margin-left: 5px; margin-top: 10px;">Prenume</label>
                <input type="text" id="first_name" placeholder="Ex: Ion" style="width: 100%; box-sizing: border-box;" />
            </div>
        </div>

        <label for="plate_number" style="font-size: 12px; color: #555; margin-left: 5px; margin-top: 10px;">NumÄƒr ÃŽnmatriculare Avariat</label>
        <input type="text" id="plate_number" placeholder="Ex: B 123 ABC" style="text-transform: uppercase;" />

        <button class="primary-btn" onclick="login()">ÃŽncepe ConversaÈ›ia</button>
        <p id="login-error" style="color: #dc3545; margin-top: 15px; font-size: 13px;"></p>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen">
        <header>
            <div>Asistent Daune</div>
            <button onclick="logout()">IeÈ™ire</button>
        </header>

        <div id="messages">
            <!-- Messages go here -->
        </div>

        <footer>
            <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileSelect()" />
            <button id="file-btn" onclick="document.getElementById('file-input').click()" title="AtaÈ™eazÄƒ fiÈ™iere (Max 100MB)">ðŸ“Ž</button>

            <input type="text" id="msg-input" placeholder="Scrie un mesaj..." onkeypress="handleEnter(event)" autocomplete="off" />

            <button id="send-btn" onclick="sendMessage()">âž¤</button>
        </footer>
    </div>
</div>

<script>
    let lastMsgId = 0;
    let pollingInterval = null;

    // --- CSRF TOKEN HELPER ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        const storedPhone = localStorage.getItem('phone');
        if (storedPhone) {
             document.getElementById('phone').value = storedPhone;
        }

        // VerificÄƒm dacÄƒ sesiunea e activÄƒ (fÄƒrÄƒ case_id local)
        checkSession();
    }

    async function checkSession() {
        try {
            // ÃŽncercÄƒm sÄƒ luÄƒm istoricul. DacÄƒ returneazÄƒ 200, suntem logaÈ›i.
            // DacÄƒ 401, nu suntem.
            const res = await fetch('/bot/chat/history/', {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });

            if (res.status === 200) {
                const data = await res.json();
                showChatScreen();
                renderHistory(data.messages);
                startPolling();
            } else if (res.status === 401 || res.status === 403) {
                // Sesiune expiratÄƒ sau inexistentÄƒ -> aratÄƒ Login
                showLoginScreen();
            } else {
                console.error("Unknown error checking session");
                showLoginScreen();
            }
        } catch (e) {
            console.error("Connection error:", e);
            showLoginScreen();
        }
    }

    function showLoginScreen() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('chat-screen').style.display = 'none';
    }

    function showChatScreen() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
    }

    // --- AUTH ---
    async function login() {
        const phone = document.getElementById('phone').value.trim();
        const first_name = document.getElementById('first_name').value.trim();
        const last_name = document.getElementById('last_name').value.trim();
        const plate_number = document.getElementById('plate_number').value.trim();
        const errElem = document.getElementById('login-error');

        if (!phone || !first_name || !last_name || !plate_number) {
            errElem.innerText = "Toate cÃ¢mpurile sunt obligatorii (Nume, Prenume, Telefon, Nr. ÃŽnmatriculare).";
            return;
        }

        const btn = document.querySelector('#login-screen button');
        btn.disabled = true;
        btn.innerText = "Se conecteazÄƒ...";

        try {
            const res = await fetch('/bot/chat/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({phone, first_name, last_name, plate_number})
            });
            const data = await res.json();

            if (res.ok && data.success) {
                localStorage.setItem('phone', phone);
                showChatScreen();
                loadHistory(); // Re-fetch clean history
                startPolling();
            } else {
                if (res.status === 429) {
                     errElem.innerText = "Prea multe Ã®ncercÄƒri. AÈ™teptaÈ›i un minut.";
                } else {
                     errElem.innerText = data.error || "Eroare la autentificare";
                }
            }
        } catch (e) {
            errElem.innerText = "Eroare de conexiune. VerificÄƒ internetul.";
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "ÃŽncepe ConversaÈ›ia";
        }
    }

    function logout() {
        // OpÈ›ional: Putem face un call la backend pentru logout
        // DeocamdatÄƒ doar reÃ®ncÄƒrcÄƒm pagina, backend-ul va pÄƒstra sesiunea.
        // DacÄƒ userul vrea sÄƒ iasÄƒ explicit, ar trebui sÄƒ È™tergem sesiunea.
        // Pentru simplitate, doar reload page.
        location.reload();
    }

    // --- MESSAGING ---
    async function loadHistory() {
        try {
            const res = await fetch(`/bot/chat/history/`, {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (res.status === 401) { logout(); return; }

            const data = await res.json();
            renderHistory(data.messages);
        } catch (e) {
            console.error("History error:", e);
        }
    }

    function renderHistory(messages) {
        const msgs = document.getElementById('messages');
        msgs.innerHTML = '';
        lastMsgId = 0;

        if (messages) {
            messages.forEach(msg => {
                appendMessage(msg);
                if (msg.id > lastMsgId) lastMsgId = msg.id;
            });
            setTimeout(scrollToBottom, 100);
        }
    }

    function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`/bot/chat/poll/?last_id=${lastMsgId}`, {
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });

                if (res.status === 401) {
                    clearInterval(pollingInterval);
                    logout();
                    return;
                }
                if (res.status === 429) return; // Rate limited, skip this poll

                const data = await res.json();
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        if (msg.id > lastMsgId) {
                            appendMessage(msg);
                            lastMsgId = msg.id;
                        }
                    });
                    scrollToBottom();
                }
            } catch (e) {
                console.error("Polling error:", e);
            }
        }, 3000);
    }

    function appendMessage(msg) {
        const msgs = document.getElementById('messages');
        const row = document.createElement('div');

        const isUser = msg.direction === 'IN';
        row.className = `message-row ${isUser ? 'in' : 'out'}`;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        // Content Sanitization handled by browser mostly if using innerText,
        // but we want basic HTML formatting (links, newlines).
        // Backend handles storage sanitization.
        let content = msg.content || "";
        // Basic escaping just in case
        content = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        content = content.replace(/\n/g, '<br>');

        const urlRegex = /(https?:\/\/[^\s]+)/g;
        content = content.replace(urlRegex, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>');

        bubble.innerHTML = content;
        row.appendChild(bubble);

        const ts = document.createElement('div');
        ts.className = 'timestamp';
        try {
            const date = new Date(msg.timestamp);
            ts.innerText = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch(e) { ts.innerText = ""; }
        row.appendChild(ts);

        if (!isUser && msg.metadata && msg.metadata.buttons) {
             const btnContainer = document.createElement('div');
             btnContainer.className = 'buttons-container';
             msg.metadata.buttons.forEach(btnText => {
                 const btn = document.createElement('button');
                 btn.className = 'chat-option-btn';
                 btn.innerText = btnText;
                 btn.onclick = () => sendMessage(btnText);
                 btnContainer.appendChild(btn);
             });
             row.appendChild(btnContainer);
        }

        msgs.appendChild(row);
    }

    function scrollToBottom() {
        const msgs = document.getElementById('messages');
        msgs.scrollTop = msgs.scrollHeight;
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage(text = null) {
        const input = document.getElementById('msg-input');
        const val = text || input.value.trim();

        if (!val) return;

        input.value = '';
        input.focus();

        const formData = new FormData();
        formData.append('message', val);

        try {
            const res = await fetch('/bot/chat/send/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            });

            if (res.status === 401) { logout(); return; }
            if (res.status === 429) { alert("Prea multe mesaje. AÈ™teptaÈ›i puÈ›in."); return; }
            if (!res.ok) {
                 const data = await res.json();
                 alert("Eroare: " + (data.error || "NecunoscutÄƒ"));
            }
        } catch (e) {
            alert("Eroare trimitere: " + e.message);
        }
    }

    async function handleFileSelect() {
        const input = document.getElementById('file-input');
        if (input.files.length > 0) {
            const formData = new FormData();

            for (let i = 0; i < input.files.length; i++) {
                formData.append('file_' + i, input.files[i]);
            }

            const msgs = document.getElementById('messages');
            const loading = document.createElement('div');
            loading.className = 'loading-indicator';
            loading.innerText = 'Se Ã®ncarcÄƒ fiÈ™ierele...';
            msgs.appendChild(loading);
            scrollToBottom();

            try {
                const res = await fetch('/bot/chat/send/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                });

                loading.remove();

                if (res.status === 401) { logout(); return; }
                if (res.status === 413) { alert("FiÈ™ier prea mare!"); return; } // Nginx usually 413

                if (!res.ok) {
                    const data = await res.json();
                    alert("Eroare upload: " + (data.error || "NecunoscutÄƒ"));
                }

                input.value = '';
            } catch (e) {
                loading.remove();
                alert('Eroare upload.');
                console.error(e);
            }
        }
    }
</script>

</body>
</html>
